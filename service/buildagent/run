#!/bin/bash
set -e

AGENT_DIR=/opt/buildAgent

if [ -z "$TEAMCITY_SERVER" ]; then
    echo "TEAMCITY_SERVER variable not set, launch with -e TEAMCITY_SERVER=http://mybuildserver:myport"
    exit 1
fi

if [ ! -d "$AGENT_DIR" ]; then
    echo "$AGENT_DIR doesn't exist pulling build-agent from server $TEAMCITY_SERVER";

    wget $TEAMCITY_SERVER/update/buildAgent.zip &&\
    unzip -d $AGENT_DIR buildAgent.zip &&\
    rm buildAgent.zip

    chmod +x $AGENT_DIR/bin/agent.sh
    echo "serverUrl=$TEAMCITY_SERVER" > $AGENT_DIR/conf/buildAgent.properties
    echo "workDir=/data/work" >> $AGENT_DIR/conf/buildAgent.properties
    echo "tempDir=/data/temp" >> $AGENT_DIR/conf/buildAgent.properties
    echo "systemDir=../system" >> $AGENT_DIR/conf/buildAgent.properties

    chown -R teamcity-agent:root $AGENT_DIR
fi

echo "Starting build-agent in $AGENT_DIR"
exec /sbin/setuser teamcity-agent $AGENT_DIR/bin/agent.sh run