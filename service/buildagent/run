#!/bin/bash
set -e

AGENT_DIR=/data/buildAgent
if [ -z "$TEAMCITY_SERVER" ]; then
    echo "TEAMCITY_SERVER environment variable not set, launch with -e TEAMCITY_SERVER=http://mybuildserver:myport"
    exit 1
fi

mkdir -p $AGENT_DIR
rm -rf $AGENT_DIR/*

echo "Pulling build-agent from server $TEAMCITY_SERVER into $AGENT_DIR";


wget $TEAMCITY_SERVER/update/buildAgent.zip &&\
unzip -d $AGENT_DIR buildAgent.zip &&\
rm buildAgent.zip

chmod +x $AGENT_DIR/bin/agent.sh

echo "serverUrl=$TEAMCITY_SERVER" > $AGENT_DIR/conf/buildAgent.properties
echo "name=$HOSTNAME" >> $AGENT_DIR/conf/buildAgent.properties
echo "workDir=$AGENT_DIR/work" >> $AGENT_DIR/conf/buildAgent.properties
echo "tempDir=$AGENT_DIR/temp" >> $AGENT_DIR/conf/buildAgent.properties
chown -R teamcity-agent:root $AGENT_DIR


echo "Starting build-agent in $AGENT_DIR"
exec /sbin/setuser teamcity-agent ${AGENT_DIR}/bin/agent.sh run
